---
layout:     post
title:      MQTT
subtitle:   Message Queuing Telemetry Transport，消息队列遥测传输协议
date:       2019-12-27
author:     LXG
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - mqtt
---

[mqtt.org-官网](http://mqtt.org/)

[MQTT中文网](http://mqtt.p2hp.com/)

[MQTT协议3.1.1](https://mcxiaoke.gitbook.io/mqtt/)

## 概述

![mqtt_concept](/images/mqtt/mqtt_concept.webp)

## 协议流程图

![mqtt_process](/images/mqtt/mqtt_process.png)

## 服务器搭建

[实战](https://www.jianshu.com/p/73436a5cf855)

### 下载apache-apollo

[apache-apollo-1.7.1-unix-distro.tar.gz](http://archive.apache.org/dist/activemq/activemq-apollo/1.7.1/)

![apollo_download](/images/mqtt/apollo_download.png)

### 查看帮助信息

**./apollo**

```txt

ProgramFiles/apache-apollo-1.7.1/bin$ ./apollo
usage: apollo [--log <log_level>] <command> [<args>]

The most commonly used apollo commands are:
    create           creates a new broker instance
    disk-benchmark   Benchmarks your disk's speed
    help             Display help information
    version          Displays the broker version

See 'apollo help <command>' for more information on a specific command.

```

### 创建服务器实例

**./apollo create sunmi_broker**

```txt

ProgramFiles/apache-apollo-1.7.1/bin$ ./apollo create sunmi_broker
Creating apollo instance at: sunmi_broker
Generating ssl keystore...

You can now start the broker by executing:

   "/home/lixiaogang/sunmi/ProgramFiles/apache-apollo-1.7.1/bin/sunmi_broker/bin/apollo-broker" run

Or you can setup the broker as system service and run it in the background:

   sudo ln -s "/home/lixiaogang/sunmi/ProgramFiles/apache-apollo-1.7.1/bin/sunmi_broker/bin/apollo-broker-service" /etc/init.d/
   /etc/init.d/apollo-broker-service start

```

### 运行服务器

**./bin/apollo-broker run**

```txt

ProgramFiles/apache-apollo-1.7.1/bin/sunmi_broker$ ./bin/apollo-broker run

    _____                .__  .__
   /  _  \ ______   ____ |  | |  |   ____
  /  /_\  \\____ \ /  _ \|  | |  |  /  _ \
 /    |    \  |_> >  <_> )  |_|  |_(  <_> )
 \____|__  /   __/ \____/|____/____/\____/
         \/|__|  Apache Apollo (1.7.1)


Loading configuration file '/home/lixiaogang/sunmi/ProgramFiles/apache-apollo-1.7.1/bin/sunmi_broker/etc/apollo.xml'.
INFO  | OS     : Linux 4.4.0-170-generic (Ubuntu 16.04.6 LTS)
INFO  | JVM    : OpenJDK 64-Bit Server VM 1.7.0_95 (Oracle Corporation)
INFO  | Apollo : 1.7.1 (at: /home/lixiaogang/sunmi/ProgramFiles/apache-apollo-1.7.1)
INFO  | OS is restricting the open file limit to: 100000
INFO  | Starting store: leveldb store at /home/lixiaogang/sunmi/ProgramFiles/apache-apollo-1.7.1/bin/sunmi_broker/data
INFO  | Accepting connections at: tcp://0.0.0.0:61613
INFO  | Accepting connections at: tls://0.0.0.0:61614
INFO  | Accepting connections at: ws://0.0.0.0:61623/
INFO  | Accepting connections at: wss://0.0.0.0:61624/
INFO  | Administration interface available at: https://127.0.0.1:61681/
INFO  | Administration interface available at: http://127.0.0.1:61680/

```

### 服务器配置

![mqtt_etc](/images/mqtt/mqtt_etc.png)

**密码配置：users.properties**

### 浏览器登录

**http://127.0.0.1:61680/console/index.html**

Username: admin
Password: password

![apolo_login](/images/mqtt/apolo_login.png)

### 服务器操作

![apollo_server](/images/mqtt/apollo_server.png)

## Android客户端

[Paho Android Service](https://github.com/eclipse/paho.mqtt.android)

Android中使用MQTT需要使用到Paho Android Service库，Paho Android Service是一个用Java编写的MQTT客户端库

### build.gradle

```gradle

repositories {
    maven {
        url 'http://maven.aliyun.com/nexus/content/groups/public/'
        url "https://repo.eclipse.org/content/repositories/paho-snapshots/"
    }
}


dependencies {
    implementation 'org.eclipse.paho:org.eclipse.paho.client.mqttv3:1.1.0'
    implementation 'org.eclipse.paho:org.eclipse.paho.android.service:1.1.1'
}

```

### AndroidManifest.xml

```xml

    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
    <uses-permission android:name="android.permission.WAKE_LOCK" />

    <service android:name="org.eclipse.paho.android.service.MqttService" /> <!--MqttService-->
    <service android:name="com.dongyk.service.MyMqttService"/> <!--MyMqttService-->

```




