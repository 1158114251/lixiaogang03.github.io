---
layout:     post
title:      Linux TC 命令
subtitle:   Traffic Control 流量控制
date:       2019-11-07
author:     LXG
header-img: img/post-bg-os-metro.jpg
catalog: true
tags:
    - linux
    - tc
---

[深入理解android-看云](https://www.kancloud.cn/alex_wsc/android-wifi-nfc-gps/414026)

## 概念

TC 是 Traffic Control 的缩写。在Linux中，流量控制是通过建立数据包队列(Queue)，并控制各个队列中数据包的发送方式实现的

## 基本工作原理

![linux_tc](/images/netd/linux_tc.jpg)

* 接收包从输入接口 (Input Interface) 进来后，将经过输入流量限制 (Ingress Policing) 以丢弃不符合规定的数据包。而符合规定的数据包则交给输入多路选择器材 (Input De-Multiplexing) 进行判断选择

* 输入多路选择器的选择结果是，如果数据包的目地是本机，则将该包送给上层处理，否则需要将数据交到转发块 (Forwarding Blcok) 去处理。转发块同时也接收来自本机上层 (TCP\UDP) 产生的数据包

* 转发块通过查看路由表，决定处理包的下一个目的地。然后，转发块对数据包进行排列整合以便将它们送到对应的输出接口 (Output Interface)

## 具体实现

系统会建立许多队列及对应的队列规则 (queuing disipline, 简称qdisc)

* 针对网络物理设备（如以太网卡eth0）绑定一个队列qdisc

* 在该队列上建立class

* 为每一个分类建立一个基于路由的过滤器filter

* 最后与过滤器配合，建立特定的路由表

### 无分类的队列规则（Classless qdisc）

该规则对进入网卡的数据包不加区分，统一对待。使用这种规定的处理能否对数据包重新编排、延迟或丢弃。这种类型是针对整个网卡的流量进行调整。

常用的qdisc如下：

* fifo(First In First Out, 先进先出队列)：最简单的控制

* SFQ(Stochastic Fairness Queuing, 随机公平队列)：对发送会话进行重排，每个发送会话可以公平的发送数据

* RED(Random Eraly Detection, 前向随机丢包)：用于模拟流量接近带宽限制时丢包的情况

* TBF(Token Bucket Fliter, 令牌桶过滤器)：可较好地使得流量降低到预设值。适合高带宽的环境。这类qdisc使用的流量控制手段主要是排序、限速、丢包











