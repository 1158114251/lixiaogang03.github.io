---
layout:     post
title:      Android 架构
subtitle:   AOSP
date:       2020-10-16
author:     LXG
header-img: img/post-bg-android.jpg
catalog: true
tags:
    - android
---

[Android 架构-AOSP](https://source.android.google.cn/devices/architecture?hl=zh-cn)

## 架构图

![ape_fwk_all](/images/android_r/ape_fwk_all.png)

## 模块化系统组件

Android 10 中采用了一些模块化 Android 系统组件，使其能够在正常的 Android 发布周期之外进行更新。最终用户设备可以从 Google Play 商店基础架构或通过合作伙伴提供的无线下载 (OTA) 机制接收这些模块化系统组件的更新。

![modular_system_components_arch](/images/android_r/modular_system_components_arch.png)

```txt

android/out/target/product/qssi/system/apex$ tree -L 4
.
├── com.android.adbd
│   ├── apex_manifest.pb
│   ├── apex_pubkey
│   ├── bin
│   │   └── adbd
│   ├── etc
│   │   └── init.rc
│   ├── lib
│   │   ├── libadbconnection_client.so
│   │   ├── libadb_pairing_auth.so
│   │   ├── libadb_pairing_connection.so
│   │   ├── libadb_pairing_server.so
│   │   ├── libbase.so -> /system/lib/libbase.so
│   │   ├── libcrypto.so -> /system/lib/libcrypto.so
│   │   ├── libcrypto_utils.so -> /system/lib/libcrypto_utils.so
│   │   ├── libc++.so -> /system/lib/libc++.so
│   │   └── libcutils.so -> /system/lib/libcutils.so
│   └── lib64
│       ├── libadbconnection_client.so
│       ├── libadb_pairing_auth.so
│       ├── libadb_pairing_connection.so
│       ├── libadb_pairing_server.so
│       ├── libadb_protos.so
│       ├── libbase.so -> /system/lib64/libbase.so
│       ├── libcrypto.so -> /system/lib64/libcrypto.so
│       ├── libcrypto_utils.so -> /system/lib64/libcrypto_utils.so
│       ├── libc++.so -> /system/lib64/libc++.so
│       ├── libcutils.so -> /system/lib64/libcutils.so
│       └── libprotobuf-cpp-lite.so -> /system/lib64/libprotobuf-cpp-lite.so
├── com.android.art.debug
├── com.android.cellbroadcast
├── com.android.conscrypt
├── com.android.extservices
├── com.android.i18n
├── com.android.ipsec
├── com.android.media
├── com.android.mediaprovider
├── com.android.media.swcodec
├── com.android.neuralnetworks
├── com.android.os.statsd
├── com.android.permission
│   ├── apex_manifest.pb
│   ├── apex_pubkey
│   ├── javalib
│   │   ├── framework-permission.jar
│   │   └── service-permission.jar
│   └── priv-app
│       └── PermissionController
│           └── PermissionController.apk
├── com.android.resolv
├── com.android.runtime
├── com.android.sdkext
├── com.android.tethering
├── com.android.tzdata
├── com.android.vndk.current
└── com.android.wifi

```

## APEX 文件格式

[APEX 文件格式](https://source.android.google.cn/devices/tech/ota/apex?hl=zh-cn)

Android Pony EXpress (APEX) 是 Android 10 中引入的一种容器格式，用于在较低级别系统模块的安装流程中使用。此格式可帮助更新不适用于标准 Android 应用模型的系统组件。一些示例组件包括原生服务和原生库、硬件抽象层 (HAL)、运行时 (ART) 以及类库。

![apex-format](/images/android_r/apex-format.png)

APEX 文件是有效的 APK 文件，因为它们是包含 AndroidManifest.xml 文件的已签名 ZIP 归档文件（使用 APK 签名方案）。这允许 APEX 文件使用 APK 文件的基础架构，例如软件包安装程序应用、签名实用程序和软件包管理器。

```txt

android/out/target/product/qssi/system/apex$ tree -L 4

├── com.android.permission
│   ├── apex_manifest.pb
│   ├── apex_pubkey
│   ├── javalib
│   │   ├── framework-permission.jar
│   │   └── service-permission.jar
│   └── priv-app
│       └── PermissionController
│           └── PermissionController.apk

android/frameworks/base/apex/permission$ tree
.
├── Android.bp
├── apex_manifest.json
├── com.android.permission.avbpubkey
├── com.android.permission.pem
├── com.android.permission.pk8
├── com.android.permission.x509.pem
├── framework
│   ├── Android.bp
│   ├── api
│   │   ├── current.txt
│   │   ├── module-lib-current.txt
│   │   ├── module-lib-removed.txt
│   │   ├── removed.txt
│   │   ├── system-current.txt
│   │   └── system-removed.txt
│   └── java
│       └── android
│           └── permission
│               └── PermissionState.java
├── OWNERS
├── service
│   ├── Android.bp
│   ├── api
│   │   ├── current.txt
│   │   ├── removed.txt
│   │   ├── system-server-current.txt
│   │   └── system-server-removed.txt
│   └── java
│       └── com
│           └── android
│               ├── permission
│               │   └── persistence
│               │       ├── IoUtils.java
│               │       ├── RuntimePermissionsPersistenceImpl.java
│               │       ├── RuntimePermissionsPersistence.java
│               │       └── RuntimePermissionsState.java
│               └── role
│                   └── persistence
│                       ├── RolesPersistenceImpl.java
│                       ├── RolesPersistence.java
│                       └── RolesState.java
├── testing
│   ├── Android.bp
│   └── test_manifest.json
├── TEST_MAPPING
└── tests
    ├── Android.bp
    ├── AndroidManifest.xml
    └── java
        └── com
            └── android
                ├── permission
                │   └── persistence
                │       └── RuntimePermissionsPersistenceTest.kt
                └── role
                    └── persistence
                        └── RolesPersistenceTest.kt

```






